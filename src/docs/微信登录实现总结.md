# 微信小程序静默登录功能实现总结

## 新增文件

### 1. `src/common/store.ts`
Vuex store，管理登录状态和用户信息：
- `login` action：自动静默登录
- `handleApiError` action：处理 token 过期并自动重新登录
- `getUserInfo` action：获取用户信息
- 防止重复登录请求

### 2. `src/pages/profile.mpx`
用户信息页面，包含：
- 显示用户头像、昵称、积分
- 显示账号信息（手机号、注册时间）
- 退出登录功能（退出后自动重新登录）

### 3. `src/docs/微信登录功能说明.md`
详细的功能说明文档

## 修改文件

### 1. `src/app.mpx`
- 引入 store 和 mpxFetch
- 添加全局请求拦截器，自动在 header 中添加 token
- 添加全局响应拦截器，处理 token 过期（code: 101/103 或 status: 401）
- 在 onLaunch 中调用 `store.dispatch('login')` 实现静默登录
- 移除 login 页面路由

### 2. `src/common/request.ts`
- 从 store 获取 token 而不是从本地存储
- 401 错误时触发 `store.dispatch('handleApiError')`
- 移除跳转到登录页的逻辑

### 3. `src/common/api.ts`
- 新增 `authApi` 对象，包含登录、获取用户信息、绑定手机号等接口
- 修改 `uploadBackground` 方法，从 store 读取 token

### 4. `src/pages/index.mpx`
- 添加"我的"按钮，跳转到用户信息页面

## 后端接口

后端接口已在 `../apis.lihuanyu.com/src/modules/ai-companion` 中实现：

### 控制器
- `controllers/auth.controller.ts` - 认证相关接口

### 服务
- `services/auth.service.ts` - 认证业务逻辑

### DTO
- `dto/wechat-login.dto.ts` - 微信登录请求参数
- `dto/bind-phone.dto.ts` - 绑定手机号请求参数

### 实体
- `entities/companion-user.entity.ts` - 用户实体

## 功能流程

1. 用户打开小程序
2. `app.mpx` 的 `onLaunch` 自动调用 `store.dispatch('login')`
3. store 检查是否已有 token，如果有则直接返回
4. 如果没有 token，调用 `mpx.login()` 获取 code
5. 将 code 发送到后端 `/companion/auth/wechat`
6. 后端调用微信接口获取 openid
7. 后端查找或创建用户，生成 JWT token
8. 前端保存 token 到 store 和本地存储
9. 所有后续请求自动携带 token

## Token 过期处理

1. 请求返回 401 或 code 101/103 时
2. 全局拦截器自动捕获错误
3. 调用 `store.dispatch('handleApiError')`
4. 自动重新登录获取新 token
5. 提示用户"登录已刷新"

## 与 AI-paint-mini 的对比

本实现完全参考了 AI-paint-mini 的登录流程：

1. **静默登录**：无需用户手动点击登录按钮
2. **Store 管理**：使用 @mpxjs/store 管理登录状态
3. **请求拦截器**：自动添加 token 和处理过期
4. **防重复登录**：使用 loginPromise 防止重复请求
5. **自动重新登录**：token 过期时自动刷新

## 测试说明

### 开发环境
在 `src/common/config.ts` 中配置：
```typescript
export const API_BASE_URL = 'http://localhost:3010'
export const REQUEST_TIMEOUT = 30000
```

### 生产环境
需要配置：
1. 微信小程序合法域名
2. 后端 CORS 配置
3. 微信 AppID 和 AppSecret（在后端 `auth.controller.ts` 中配置）

## 注意事项

1. 微信小程序需要在微信公众平台配置服务器域名
2. 确保后端接口的 CORS 配置正确
3. 生产环境需要使用真实的微信 AppID 和 AppSecret
4. token 过期时间由后端 JWT 配置决定
5. 用户首次注册会赠送 100 积分
6. 退出登录后会自动重新登录（静默登录）

