# 微信小程序静默登录功能

## 功能说明

参考 AI-paint-mini 项目，实现了完整的微信小程序静默登录功能：

1. **自动静默登录**
   - 小程序启动时自动调用微信登录
   - 无需用户手动点击登录按钮
   - 后台自动获取 code 并换取 token

2. **用户信息页面** (`src/pages/profile.mpx`)
   - 显示用户头像、昵称、积分
   - 显示账号信息（手机号、注册时间）
   - 退出登录功能（退出后自动重新登录）

3. **Store 状态管理** (`src/common/store.ts`)
   - 使用 @mpxjs/store 管理登录状态
   - 自动处理 token 过期和重新登录
   - 防止重复登录请求

4. **请求拦截器** (`src/app.mpx`)
   - 自动在请求头中添加 token
   - 自动处理 401 错误并重新登录
   - 无需手动管理 token

## 后端接口

后端接口位于 `../apis.lihuanyu.com/src/modules/ai-companion/controllers/auth.controller.ts`

### 登录接口

```
POST /companion/auth/wechat
```

请求参数：
```typescript
{
  code: string        // 微信登录 code
  nickName?: string   // 用户昵称（可选）
  avatarUrl?: string  // 用户头像（可选）
}
```

返回数据：
```typescript
{
  token: string
  user: {
    id: number
    name: string
    avatarUrl: string
    provider: string
    points: number
  }
}
```

### 获取用户信息

```
GET /companion/auth/me
```

需要在 header 中携带 token：
```
Authorization: Bearer {token}
```

### 绑定手机号

```
POST /companion/auth/bind-phone
```

请求参数：
```typescript
{
  phone: string
}
```

## 登录流程

1. 用户打开小程序
2. `app.mpx` 的 `onLaunch` 自动调用 `store.dispatch('login')`
3. store 检查是否已有 token，如果有则直接返回
4. 如果没有 token，调用 `mpx.login()` 获取 code
5. 将 code 发送到后端 `/companion/auth/wechat`（静默登录时不传 nickName 和 avatarUrl）
6. 后端调用微信接口获取 openid
7. 后端查找或创建用户，生成 JWT token
   - 如果是新用户且没有传 nickName，后端会使用默认名称"新用户"
   - 如果是老用户，保持原有的用户信息
8. 前端保存 token 到 store 和本地存储
9. 所有后续请求自动携带 token

**注意**：静默登录时无法获取用户的昵称和头像（需要用户授权 `open-type="getUserInfo"`），所以只传递 code。如果需要更新用户信息，可以在用户主动授权后调用更新接口。

## Token 过期处理

1. 请求返回 401 或 code 101/103 时
2. 全局拦截器自动捕获错误
3. 调用 `store.dispatch('handleApiError')`
4. 自动重新登录获取新 token
5. 提示用户"登录已刷新"

## 本地开发

在 `src/common/config.ts` 中配置：

```typescript
export const API_BASE_URL = 'http://localhost:3010'
export const REQUEST_TIMEOUT = 30000
```

开发环境下，可以在后端使用测试 token 进行调试。

## 注意事项

1. 微信小程序需要配置合法域名才能正常使用登录功能
2. 需要在微信公众平台配置服务器域名
3. 确保后端接口的 CORS 配置正确
4. 生产环境需要使用真实的微信 AppID 和 AppSecret
5. 用户首次注册会赠送 100 积分
6. 退出登录后会自动重新登录（静默登录）

