# 角色聊天功能文档

## 一、概述
角色聊天是小程序的核心功能线，包含角色发现、选择、对话、管理等完整流程。

---

## 二、功能模块

### 2.1 角色广场（角色发现）
**页面**：`src/pages/characters.mpx`

#### 功能点
- 展示官方角色列表
- 展示用户自定义角色列表
- 支持创建自定义角色
- 点击角色卡片进入聊天

#### 数据结构
```typescript
interface Character {
  id: number
  name: string
  avatarUrl: string | null
  description: string | null
  systemPrompt: string
  greetingMessage: string | null
  isOfficial: number
  // 聊天统计（需认证）
  hasChatHistory?: boolean
  messageCount?: number
  likeCount?: number
}
```

#### 业务逻辑
- 分别加载官方角色和自定义角色
- 区分显示：我的角色 / 官方角色
- 点击角色：创建新对话并跳转聊天页

---

### 2.2 角色选择页（沉浸式卡片）
**页面**：`src/pages/character-select.mpx`

#### 功能点
1. **沉浸式展示**
   - 全屏滑动卡片（垂直滑动）
   - 角色背景图 + 渐变遮罩
   - 滑动提示（首次显示 3 秒）

2. **角色信息展示**
   - 角色介绍（仅首次聊天显示）
   - 问候语消息
   - 角色名称和作者标识（官方/用户创建）

3. **交互工具栏**
   - **点赞**：展示点赞数（功能开发中）
   - **历史消息**：展示消息数，点击跳转聊天页
   - **收藏**：本地收藏功能
     - 使用 LocalStorage 存储（key: `favorite_characters`）
     - 实时更新收藏状态
   - **固定到首页**：
     - 缓存角色信息到 LocalStorage
     - 点亮星标图标
     - 同时只能固定一个角色

4. **快捷聊天**
   - 输入框直接输入消息
   - 发送时自动创建对话并跳转
   - 切换卡片时清空输入框

#### 组件化
- **角色卡片内容组件**：`src/components/character-card-content.mpx`
  - Props: `character`, `inputText`
  - Events: `like`, `viewHistory`, `toggleFavorite`, `pinToHome`, `input`, `sendMessage`

#### 数据存储
| Key | 用途 | 数据类型 |
|-----|------|---------|
| `favorite_characters` | 收藏角色 ID 列表 | number[] |
| `home_character` | 固定到首页的角色 | Object |

---

### 2.3 聊天对话页
**页面**：`src/pages/chat.mpx`

#### 进入方式
1. **从角色列表**：传入 `characterId`，创建新对话
2. **从对话历史**：传入 `conversationId`，加载历史消息
3. **从角色选择页**：传入 `conversationId` + `initialMessage`，自动发送首条消息

#### 功能点
1. **消息展示**
   - 滚动视图展示消息列表
   - 消息气泡组件（用户/AI）
   - 自动滚动到底部

2. **消息发送**
   - 输入框（支持回车发送）
   - 发送按钮（有内容时高亮）
   - 发送状态提示（发送中/完成）

3. **固定到首页**
   - 星标按钮（☆/★）
   - 更新 `home_character` 缓存
   - 同时更新 `conversationId`

4. **首次对话逻辑**
   - 创建对话时返回 `isFirstTimeChat` 标识
   - 首次对话：返回 greeting 消息
   - 非首次：返回最近 20 条历史消息

#### API 调用
- **创建对话**：`POST /companion/conversations`
  - 入参：`characterId`
  - 返回：对话信息 + 初始消息列表
- **发送消息**：`POST /companion/conversations/:id/messages`
  - 入参：`content`
  - 返回：用户消息 + AI 回复 + 积分消耗
- **获取历史**：`GET /companion/conversations/:id/messages`

#### 缓存更新
- 发送消息成功后，更新 `last_conversation_id`
- 固定到首页时，更新 `home_character` 的 `conversationId`

---

### 2.4 对话列表页
**页面**：`src/pages/conversations.mpx`

#### 功能点
1. **对话列表**
   - 展示所有对话记录
   - 显示角色头像、名称、消息数、最后消息时间
   - 按最后消息时间倒序排列

2. **对话管理**
   - 点击对话项：跳转到聊天页继续对话
   - 删除对话：长按或点击删除按钮

3. **空状态**
   - 无对话时引导用户去首页选择角色

#### 时间格式化
- 当天：显示具体时间（如 14:30）
- 昨天：显示"昨天"
- 更早：显示日期（如 12-20）

---

### 2.5 自定义角色创建
**页面**：`src/pages/create-character.mpx`

#### 功能点（待验证）
- 填写角色信息
  - 角色名称
  - 角色描述
  - 系统提示词（定义角色性格）
  - 问候语
  - 头像上传
- 创建成功后返回角色列表

---

## 三、核心业务流程

### 3.1 首次聊天流程
```
用户点击角色
  → 创建对话（POST /conversations）
  → 返回对话 ID + greeting 消息
  → 展示 greeting
  → 用户发送消息
  → 正常聊天
```

### 3.2 继续聊天流程
```
用户点击对话记录
  → 加载历史消息（GET /conversations/:id/messages）
  → 展示最近 20 条消息
  → 用户发送消息
  → 正常聊天
```

### 3.3 固定到首页流程
```
聊天页点击星标按钮
  → 更新 home_character 缓存
    - characterId
    - conversationId
    - character 基本信息
  → 取消其他角色的固定状态
  → 首页自动使用该角色
```

### 3.4 收藏功能流程
```
角色选择页点击收藏按钮
    进入页面 (loadCharacters)
      ↓
  清空本地缓存 → 从后端获取 → 初始化本地缓存
      ↓
  用户点击收藏 (handleToggleFavorite)
      ↓
  1. 乐观更新 UI
  2. 更新本地缓存
  3. 调用后端接口
  4. 失败则回滚 UI + 缓存

  特点：
  - 每次进入页面以后端数据为准（多设备同步）
  - 当前会话内乐观更新（用户体验好）
  - 失败时回滚（数据一致性）

```

---

## 四、数据流转

### 4.1 LocalStorage 缓存
| Key | 说明 | 更新时机 |
|-----|------|---------|
| `home_character` | 固定角色 | 聊天页固定、角色选择页固定 |
| `last_conversation_id` | 最近对话 | 发送消息成功后 |
| `favorite_characters` | 收藏列表 | 角色选择页点击收藏 |
| `greeting_cache` | 问候语缓存 | 首页后台预取 |

### 4.2 角色统计字段
后端返回的角色对象包含聊天统计（需认证）：
- `hasChatHistory`：是否有聊天记录
- `messageCount`：消息总数
- `likeCount`：点赞数

前端状态字段（本地管理）：
- `isFavorite`：是否收藏
- `isPinned`：是否固定到首页

---

## 五、待完善功能
- [ ] 点赞功能实现
- [ ] 收藏列表页
- [ ] 对话搜索
- [ ] 消息复制/分享
- [ ] 语音输入
- [ ] 图片消息
- [ ] 多轮对话上下文优化
- [ ] 对话导出
- [ ] 角色标签分类
- [ ] 角色推荐算法

---

## 六、相关文件
**页面**
- `src/pages/characters.mpx` - 角色广场
- `src/pages/character-select.mpx` - 角色选择（沉浸式）
- `src/pages/chat.mpx` - 聊天对话
- `src/pages/conversations.mpx` - 对话列表
- `src/pages/create-character.mpx` - 创建角色

**组件**
- `src/components/character-card-content.mpx` - 角色卡片内容

**API**
- `src/common/api.ts` - API 接口封装
- `src/common/types.ts` - 类型定义

---

**最后更新**：2025-12-25

