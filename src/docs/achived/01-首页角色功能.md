# 首页角色功能文档

## 一、概述
首页是用户进入小程序后的默认落地页，提供固定角色的展示和快捷操作入口。

---

## 二、核心功能

### 2.1 角色固定机制
- **功能描述**：用户可以将喜欢的角色固定到首页，作为默认陪伴角色
- **存储方式**：LocalStorage 缓存（key: `home_character`）
- **缓存数据结构**：
  ```typescript
  {
    characterId: number,        // 角色 ID
    conversationId: number | null,  // 对话 ID（创建对话后更新）
    character: {                // 角色基本信息
      id: number,
      name: string,
      avatarUrl: string,
      description: string
    },
    timestamp: number           // 缓存时间戳
  }
  ```
- **默认角色**：祁煜（ID: 4）

### 2.2 问候语系统
#### 2.2.1 显示逻辑
1. **优先使用缓存**：从 LocalStorage 读取问候语缓存
   - 缓存有效期：3 小时
   - 状态标记：`used` 字段标识是否已使用
2. **降级方案**：缓存失效或已使用时，从静态问候语库随机选取
3. **后台预取**：页面加载 1 秒后，后台调用 AI 接口预取下一条问候语

#### 2.2.2 预取机制
- **触发时机**：页面 onLoad 后延迟 1 秒执行
- **获取方式**：
  - 通过对话接口发送特殊指令 `[GET_GREETING]`
  - 依赖 conversationId（优先使用固定角色的对话，否则使用最近对话）
- **降级处理**：API 调用失败时使用静态问候语库
- **页面卸载保护**：通过 `_isUnloaded` 标记防止异步回调在页面卸载后执行

#### 2.2.3 缓存数据结构
```typescript
{
  text: string,       // 问候语文本
  timestamp: number,  // 缓存时间戳
  used: boolean       // 是否已使用
}
```

### 2.3 角色信息展示
- 角色名称（显示在卡片左上角标签）
- 问候语消息（以卡片形式展示）
- 背景图（使用角色头像作为背景）

### 2.4 快捷操作入口
#### 主操作按钮
- **聊天**：跳转到聊天页
  - 优先使用固定角色的 conversationId
  - 否则使用最近对话 ID（从 LocalStorage 读取）
  - 无对话时创建新对话
- **哄睡**：待开发（按钮已存在）
- **陪我一起**：待开发（按钮已存在）

#### 侧边导航
- **换角色**：跳转到角色选择页（沉浸式卡片）
- **消息**：跳转到对话列表页
- **广场**：跳转到角色广场页

---

## 三、数据存取逻辑

### 3.1 使用的缓存 Key
| Key | 用途 | 数据类型 |
|-----|------|---------|
| `home_character` | 固定到首页的角色信息 | Object |
| `greeting_cache` | 问候语缓存 | Object |
| `last_conversation_id` | 最近对话 ID（用于问候语预取） | number |

### 3.2 缓存读取顺序
1. **角色信息**：`home_character` → 默认角色（祁煜）
2. **对话 ID**：固定角色的 conversationId → `last_conversation_id` → null
3. **问候语**：`greeting_cache`（有效且未使用）→ 静态库随机

---

## 四、页面交互

### 4.1 页面生命周期
- **onLoad**：
  1. 加载固定角色信息
  2. 显示问候语（优先缓存）
  3. 后台预取新问候语
- **onUnload**：标记 `_isUnloaded = true`，阻止异步回调执行

### 4.2 跳转逻辑
- **聊天按钮**：
  - 有 conversationId → `/pages/chat?conversationId=xxx`
  - 无 conversationId → `/pages/chat?characterId=xxx`
- **换角色**：`/pages/character-select`
- **消息**：`/pages/conversations`
- **广场**：`/pages/characters`

---

## 五、待完善功能
- [ ] 哄睡功能实现
- [ ] 陪我一起功能实现
- [ ] 问候语多样性优化（根据时段、天气、用户状态等）
- [ ] 角色背景动态化（支持视频背景）
- [ ] 快捷消息按钮（常用语快速回复）

---

## 六、相关文件
- **页面文件**：`src/pages/index.mpx`
- **问候语库**：`src/common/greetings.ts`
- **API 接口**：`src/common/api.ts`
- **类型定义**：`src/common/types.ts`

---

**最后更新**：2025-12-25
