<template>
  <view class="container">
    <!-- å…¨å±æ»‘åŠ¨å®¹å™¨ -->
    <swiper
      class="character-swiper"
      vertical
      indicator-dots="{{false}}"
      current="{{currentIndex}}"
      bindchange="handleSwiperChange"
      circular="{{false}}"
    >
      <swiper-item
        wx:for="{{characters}}"
        wx:key="id"
        class="swiper-item"
      >
        <!-- è§’è‰²èƒŒæ™¯å›¾ -->
        <image
          class="bg-image"
          src="{{item.avatarUrl || '/assets/default-avatar.png'}}"
          mode="aspectFill"
        />

        <!-- æ¸å˜é®ç½© -->
        <view class="gradient-overlay"></view>

        <!-- å†…å®¹å¡ç‰‡ -->
        <view class="content-card">
          <!-- è§’è‰²ä»‹ç»ï¼ˆä»…é¦–æ¬¡èŠå¤©æ˜¾ç¤ºï¼‰ -->
          <view class="intro-section" wx:if="{{!item.hasChatHistory && item.description}}">
            <text class="intro-label">ä»‹ç»ï¼š</text>
            <text class="intro-text">{{item.description}}</text>
          </view>

          <!-- é—®å€™è¯­æ¶ˆæ¯ -->
          <view class="greeting-message">
            <text class="message-text">{{item.greetingMessage || 'ä½ å¥½~'}}</text>
          </view>

          <!-- è§’è‰²ä¿¡æ¯å’Œå·¥å…·æ  -->
          <view class="info-toolbar">
            <!-- å·¦ä¾§ï¼šè§’è‰²å’Œä½œè€…ä¿¡æ¯ -->
            <view class="character-meta">
              <text class="meta-name">{{item.name}}</text>
              <text class="meta-author">{{item.isOfficial ? 'å®˜æ–¹' : 'ç”¨æˆ·åˆ›å»º'}}</text>
            </view>

            <!-- å³ä¾§ï¼šå·¥å…·æŒ‰é’® -->
            <view class="action-tools">
              <!-- ç‚¹èµ -->
              <view class="tool-item" bindtap="handleLike" data-id="{{item.id}}">
                <text class="tool-icon">ğŸ‘</text>
                <text class="tool-count">{{item.likeCount || 0}}</text>
              </view>

              <!-- å†å²æ¶ˆæ¯ -->
              <view class="tool-item" bindtap="handleViewHistory" data-id="{{item.id}}">
                <text class="tool-icon">ğŸ’¬</text>
                <text class="tool-count">{{item.messageCount || 0}}</text>
              </view>

              <!-- æ”¶è— -->
              <view
                class="tool-item favorite-tool {{item.isFavorite ? 'active' : ''}}"
                bindtap="handleToggleFavorite"
                data-id="{{item.id}}"
              >
                <text class="tool-icon">{{item.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              </view>

              <!-- å›ºå®šåˆ°é¦–é¡µ -->
              <view
                class="tool-item pin-tool {{item.isPinned ? 'active' : ''}}"
                bindtap="handlePinToHome"
                data-character="{{item}}"
              >
                <text class="tool-icon">{{item.isPinned ? 'â˜…' : 'â˜†'}}</text>
              </view>
            </view>
          </view>

          <!-- è¾“å…¥æ¡† -->
          <view class="input-section">
            <input
              class="chat-input"
              type="text"
              placeholder="è¾“å…¥æ¶ˆæ¯å¼€å§‹èŠå¤©..."
              value="{{inputText}}"
              bindinput="handleInput"
              bindconfirm="handleSendMessage"
              data-character="{{item}}"
              confirm-type="send"
            />
            <button
              class="send-btn {{inputText ? 'active' : ''}}"
              bindtap="handleSendMessage"
              data-character="{{item}}"
              disabled="{{!inputText}}"
            >
              å‘é€
            </button>
          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- æ»‘åŠ¨æç¤ºï¼ˆä»…é¦–æ¬¡æ˜¾ç¤ºï¼‰ -->
    <view class="swipe-hint" wx:if="{{showHint}}">
      <view class="hint-arrow">â†‘</view>
      <text class="hint-text">ä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šè§’è‰²</text>
    </view>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <view class="nav-btn" bindtap="handleGoBack">
        <text class="nav-icon">â†</text>
      </view>
      <view class="nav-btn" bindtap="handleViewFavorites">
        <text class="nav-icon">â¤ï¸</text>
      </view>
    </view>
  </view>
</template>

<script lang="ts">
import { createPage } from '@mpxjs/core'
import { characterApi, conversationApi } from '../common/api'
import type { Character } from '../common/types'

const FAVORITE_CHARACTERS_KEY = 'favorite_characters'
const HOME_CHARACTER_CACHE_KEY = 'home_character'

createPage({
  data: {
    characters: [] as Character[],
    currentIndex: 0,
    showHint: true,
    favoriteIds: [] as number[],
    favoriteCount: 0,
    inputText: '',
    pinnedCharacterId: null as number | null
  },

  onLoad() {
    this.loadFavorites()
    this.loadPinnedCharacter()
    this.loadCharacters()

    // 3ç§’åéšè—æç¤º
    setTimeout(() => {
      this.showHint = false
    }, 3000)
  },

  methods: {
    // åŠ è½½è§’è‰²åˆ—è¡¨
    async loadCharacters() {
      try {
        const [myChars, officialChars] = await Promise.all([
          characterApi.getMyCharacters().catch(() => []),
          characterApi.getOfficialCharacters().catch(() => [])
        ])

        // åˆå¹¶è§’è‰²åˆ—è¡¨ï¼Œå®˜æ–¹è§’è‰²åœ¨å‰
        const allCharacters = [...officialChars, ...myChars]

        // æ·»åŠ å‰ç«¯çŠ¶æ€ï¼ˆæ”¶è—ã€å›ºå®šï¼‰
        this.characters = allCharacters.map(char => ({
          ...char,
          isFavorite: this.favoriteIds.includes(char.id),
          isPinned: this.pinnedCharacterId === char.id
          // hasChatHistory, messageCount, likeCount ç”±åç«¯è¿”å›
        }))
      } catch (err: any) {
        wx.showToast({ title: 'åŠ è½½è§’è‰²å¤±è´¥', icon: 'none' })
      }
    },

    // åŠ è½½æ”¶è—åˆ—è¡¨
    loadFavorites() {
      try {
        const favorites = wx.getStorageSync(FAVORITE_CHARACTERS_KEY) || []
        this.favoriteIds = favorites
        this.favoriteCount = favorites.length
      } catch (e) {
        this.favoriteIds = []
        this.favoriteCount = 0
      }
    },

    // åŠ è½½å›ºå®šåˆ°é¦–é¡µçš„è§’è‰²
    loadPinnedCharacter() {
      try {
        const cached = wx.getStorageSync(HOME_CHARACTER_CACHE_KEY)
        if (cached && cached.characterId) {
          this.pinnedCharacterId = cached.characterId
        }
      } catch (e) {
        this.pinnedCharacterId = null
      }
    },

    // åˆ‡æ¢æ”¶è—
    handleToggleFavorite(e: any) {
      const characterId = e.currentTarget.dataset.id
      const index = this.favoriteIds.indexOf(characterId)

      if (index > -1) {
        // å–æ¶ˆæ”¶è—
        this.favoriteIds.splice(index, 1)
        wx.showToast({ title: 'å·²å–æ¶ˆæ”¶è—', icon: 'none' })
      } else {
        // æ·»åŠ æ”¶è—
        this.favoriteIds.push(characterId)
        wx.showToast({ title: 'å·²åŠ å…¥æ”¶è—', icon: 'success' })
      }

      // ä¿å­˜åˆ°æœ¬åœ°
      wx.setStorageSync(FAVORITE_CHARACTERS_KEY, this.favoriteIds)
      this.favoriteCount = this.favoriteIds.length

      // æ›´æ–°å½“å‰è§’è‰²çš„æ”¶è—çŠ¶æ€
      this.characters = this.characters.map(char => ({
        ...char,
        isFavorite: this.favoriteIds.includes(char.id)
      }))
    },

    // å›ºå®šåˆ°é¦–é¡µ
    handlePinToHome(e: any) {
      const character = e.currentTarget.dataset.character

      if (this.pinnedCharacterId === character.id) {
        // å–æ¶ˆå›ºå®š
        wx.removeStorageSync(HOME_CHARACTER_CACHE_KEY)
        this.pinnedCharacterId = null
        wx.showToast({ title: 'å·²å–æ¶ˆå›ºå®š', icon: 'success' })
      } else {
        // å›ºå®šåˆ°é¦–é¡µ
        const cacheData = {
          characterId: character.id,
          conversationId: null, // åˆ›å»ºå¯¹è¯åä¼šæ›´æ–°
          character: {
            id: character.id,
            name: character.name,
            avatarUrl: character.avatarUrl,
            description: character.description
          },
          timestamp: Date.now()
        }

        wx.setStorageSync(HOME_CHARACTER_CACHE_KEY, cacheData)
        this.pinnedCharacterId = character.id
        wx.showToast({ title: 'å·²å›ºå®šåˆ°é¦–é¡µ', icon: 'success' })
      }

      // æ›´æ–°çŠ¶æ€
      this.characters = this.characters.map(char => ({
        ...char,
        isPinned: this.pinnedCharacterId === char.id
      }))
    },

    // ç‚¹èµ
    handleLike(e: any) {
      wx.showToast({ title: 'ç‚¹èµåŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
    },

    // æŸ¥çœ‹å†å²æ¶ˆæ¯
    handleViewHistory(e: any) {
      const characterId = e.currentTarget.dataset.id
      // TODO: æŸ¥è¯¢è¯¥è§’è‰²çš„å¯¹è¯IDï¼Œå¦‚æœæœ‰åˆ™è·³è½¬åˆ°èŠå¤©é¡µ
      wx.navigateTo({
        url: `/pages/chat?characterId=${characterId}`
      })
    },

    // è¾“å…¥æ¡†å†…å®¹å˜åŒ–
    handleInput(e: any) {
      this.inputText = e.detail.value
    },

    // å‘é€æ¶ˆæ¯
    async handleSendMessage(e: any) {
      const character = e.currentTarget.dataset.character
      const message = this.inputText.trim()

      if (!message) {
        return
      }

      // åˆ›å»ºå¯¹è¯å¹¶è·³è½¬åˆ°èŠå¤©é¡µ
      try {
        const conversation = await conversationApi.createConversation(character.id)

        // è·³è½¬åˆ°èŠå¤©é¡µï¼Œå¹¶ä¼ é€’åˆå§‹æ¶ˆæ¯
        wx.navigateTo({
          url: `/pages/chat?conversationId=${conversation.id}&initialMessage=${encodeURIComponent(message)}`
        })

        // æ¸…ç©ºè¾“å…¥æ¡†
        this.inputText = ''
      } catch (err: any) {
        wx.showToast({ title: err.message || 'åˆ›å»ºå¯¹è¯å¤±è´¥', icon: 'none' })
      }
    },

    // Swiper åˆ‡æ¢
    handleSwiperChange(e: any) {
      this.currentIndex = e.detail.current
      this.showHint = false
      // åˆ‡æ¢æ—¶æ¸…ç©ºè¾“å…¥æ¡†
      this.inputText = ''
    },

    // è¿”å›
    handleGoBack() {
      wx.navigateBack()
    },

    // æŸ¥çœ‹æ”¶è—åˆ—è¡¨
    handleViewFavorites() {
      if (this.favoriteCount === 0) {
        wx.showToast({ title: 'è¿˜æ²¡æœ‰æ”¶è—è§’è‰²', icon: 'none' })
        return
      }

      // TODO: è·³è½¬åˆ°æ”¶è—åˆ—è¡¨é¡µ
      wx.showToast({ title: 'æ”¶è—åˆ—è¡¨åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
    }
  }
})
</script>

<style lang="stylus">
.container
  width 100vw
  height 100vh
  position relative
  overflow hidden
  background-image url('../assets/qiyu.jpg')
  background-size cover
  background-position center

  .character-swiper
    width 100%
    height 100%

    .swiper-item
      position relative
      width 100%
      height 100%
      display flex
      align-items flex-end
      padding-bottom 40rpx
      box-sizing border-box
      overflow hidden

      .bg-image
        position absolute
        top 0
        left 0
        width 100%
        height 100%
        z-index 1

      .gradient-overlay
        position absolute
        top 0
        left 0
        width 100%
        height 100%
        background linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.8))
        z-index 2

      // å†…å®¹å¡ç‰‡
      .content-card
        position relative
        z-index 3
        width 100%
        padding 0 32rpx
        margin-bottom 40rpx

        // ä»‹ç»éƒ¨åˆ†
        .intro-section
          background rgba(255, 255, 255, 0.12)
          backdrop-filter blur(20rpx)
          border-radius 20rpx
          padding 24rpx 28rpx
          margin-bottom 20rpx
          border 1rpx solid rgba(255, 255, 255, 0.15)

          .intro-label
            font-size 26rpx
            color rgba(255, 255, 255, 0.7)
            font-weight 500
            margin-right 8rpx

          .intro-text
            font-size 26rpx
            color rgba(255, 255, 255, 0.95)
            line-height 1.6

        // é—®å€™è¯­æ¶ˆæ¯
        .greeting-message
          width 80%
          color rgba(255, 255, 255, 0.95)
          background-color rgba(255, 255, 255, 0.6)
          backdrop-filter blur(20rpx)
          border-radius 20rpx
          padding 28rpx
          margin-bottom 60rpx
          border 1rpx solid rgba(255, 255, 255, 0.15)

          .message-text
            font-size 30rpx
            color #333
            line-height 1.6
            display block

        // ä¿¡æ¯å’Œå·¥å…·æ 
        .info-toolbar
          display flex
          justify-content space-between
          align-items center
          margin-bottom 20rpx
          padding 0 8rpx

          .character-meta
            display flex
            flex-direction column
            gap 8rpx

            .meta-name
              font-size 32rpx
              font-weight 700
              color #fff
              text-shadow 0 2px 8px rgba(0,0,0,0.3)

            .meta-author
              font-size 24rpx
              color rgba(255, 255, 255, 0.7)

          .action-tools
            display flex
            align-items center
            gap 24rpx

            .tool-item
              display flex
              flex-direction column
              align-items center
              gap 2rpx
              transition all 0.2s

              &:active
                transform scale(0.95)

              .tool-icon
                font-size 32rpx

              .tool-count
                font-size 20rpx
                color rgba(255, 255, 255, 0.8)

              &.favorite-tool.active
                background rgba(255, 100, 100, 0.25)
                border-color rgba(255, 100, 100, 0.4)

              &.pin-tool.active
                background rgba(255, 215, 0, 0.25)
                border-color rgba(255, 215, 0, 0.4)

        // è¾“å…¥æ¡†éƒ¨åˆ†
        .input-section
          display flex
          align-items center
          gap 16rpx
          background rgba(255, 255, 255, 0.12)
          backdrop-filter blur(20rpx)
          border-radius 16rpx
          padding 12rpx 16rpx
          border 1rpx solid rgba(255, 255, 255, 0.15)

          .chat-input
            flex 1
            height 64rpx
            background transparent
            border none
            font-size 28rpx
            color #fff
            padding 0 16rpx

            &::placeholder
              color rgba(255, 255, 255, 0.5)

          .send-btn
            height 64rpx
            padding 0 32rpx
            background rgba(255, 255, 255, 0.15)
            color rgba(255, 255, 255, 0.6)
            border-radius 32rpx
            font-size 28rpx
            border none
            transition all 0.2s

            &.active
              background linear-gradient(135deg, #667eea, #764ba2)
              color #fff

            &:active
              transform scale(0.98)

            &[disabled]
              opacity 0.5

  .swipe-hint
    position absolute
    bottom 320rpx
    left 50%
    transform translateX(-50%)
    z-index 4
    text-align center

    .hint-arrow
      font-size 48rpx
      color #fff
      text-shadow 0 2px 8px rgba(0,0,0,0.3)

    .hint-text
      display block
      margin-top 8rpx
      font-size 24rpx
      color rgba(255, 255, 255, 0.9)
      text-shadow 0 1px 4px rgba(0,0,0,0.3)

  .top-nav
    position fixed
    top 0
    left 0
    right 0
    padding 160rpx 32rpx 32rpx 32rpx
    display flex
    justify-content space-between
    align-items center
    z-index 5

    .nav-btn
      position relative
      width 80rpx
      height 80rpx
      background rgba(0,0,0,0.3)
      backdrop-filter blur(10rpx)
      border-radius 50%
      display flex
      align-items center
      justify-content center
      border 1rpx solid rgba(255,255,255,0.2)

      .nav-icon
        font-size 36rpx
        color #fff

</style>

<script type="application/json">
{
  "navigationStyle": "custom",
  "navigationBarTextStyle": "white",
  "usingComponents": {}
}
</script>
