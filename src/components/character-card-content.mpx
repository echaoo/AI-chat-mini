<template>
  <!-- å†…å®¹å¡ç‰‡ -->
  <view class="content-card">
    <!-- è§’è‰²ä»‹ç»ï¼ˆä»…é¦–æ¬¡èŠå¤©æ˜¾ç¤ºï¼‰ -->
    <view class="intro-section" wx:if="{{!character.hasChatHistory && character.description}}">
      <text class="intro-label">ä»‹ç»ï¼š</text>
      <text class="intro-text">{{character.description}}</text>
    </view>

    <!-- é—®å€™è¯­æ¶ˆæ¯ -->
    <view class="greeting-message">
      <text class="message-text">{{character.greetingMessage || 'ä½ å¥½~'}}</text>
    </view>

    <!-- è§’è‰²ä¿¡æ¯å’Œå·¥å…·æ  -->
    <view class="info-toolbar">
      <!-- å·¦ä¾§ï¼šè§’è‰²å’Œä½œè€…ä¿¡æ¯ -->
      <view class="character-meta">
        <text class="meta-name">{{character.name}}</text>
        <text class="meta-author">{{character.isOfficial ? 'å®˜æ–¹' : 'ç”¨æˆ·åˆ›å»º'}}</text>
      </view>

      <!-- å³ä¾§ï¼šå·¥å…·æŒ‰é’® -->
      <view class="action-tools">
        <!-- ç‚¹èµ -->
        <view class="tool-item" bindtap="handleLike">
          <text class="tool-icon">ğŸ‘</text>
          <text class="tool-count">{{character.likeCount || 0}}</text>
        </view>

        <!-- å†å²æ¶ˆæ¯ -->
        <view class="tool-item" bindtap="handleViewHistory">
          <text class="tool-icon">ğŸ’¬</text>
          <text class="tool-count">{{character.messageCount || 0}}</text>
        </view>

        <!-- æ”¶è— -->
        <view
          class="tool-item favorite-tool {{character.isFavorite ? 'active' : ''}}"
          bindtap="handleToggleFavorite"
        >
          <text class="tool-icon">{{character.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        </view>

        <!-- å›ºå®šåˆ°é¦–é¡µ -->
        <view
          class="tool-item pin-tool {{character.isPinned ? 'active' : ''}}"
          bindtap="handlePinToHome"
        >
          <text class="tool-icon">{{character.isPinned ? 'â˜…' : 'â˜†'}}</text>
        </view>
      </view>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-section">
      <input
        class="chat-input"
        type="text"
        placeholder="è¾“å…¥æ¶ˆæ¯å¼€å§‹èŠå¤©..."
        value="{{inputText}}"
        bindinput="handleInput"
        bindconfirm="handleSendMessage"
        confirm-type="send"
      />
      <button
        class="send-btn {{inputText ? 'active' : ''}}"
        bindtap="handleSendMessage"
        disabled="{{!inputText}}"
      >
        å‘é€
      </button>
    </view>
  </view>
</template>

<script lang="ts">
import { createComponent } from '@mpxjs/core'
import type { Character } from '../common/types'

createComponent({
  properties: {
    // è§’è‰²æ•°æ®
    character: {
      type: Object as () => Character,
      value: null
    },
    // è¾“å…¥æ¡†æ–‡æœ¬
    inputText: {
      type: String,
      value: ''
    }
  },

  methods: {
    // ç‚¹èµ
    handleLike() {
      this.triggerEvent('like', { characterId: this.character.id })
    },

    // æŸ¥çœ‹å†å²æ¶ˆæ¯
    handleViewHistory() {
      this.triggerEvent('viewHistory', { characterId: this.character.id })
    },

    // åˆ‡æ¢æ”¶è—
    handleToggleFavorite() {
      this.triggerEvent('toggleFavorite', { characterId: this.character.id })
    },

    // å›ºå®šåˆ°é¦–é¡µ
    handlePinToHome() {
      this.triggerEvent('pinToHome', { character: this.character })
    },

    // è¾“å…¥æ¡†å†…å®¹å˜åŒ–
    handleInput(e: any) {
      this.triggerEvent('input', { value: e.detail.value })
    },

    // å‘é€æ¶ˆæ¯
    handleSendMessage() {
      if (this.inputText && this.inputText.trim()) {
        this.triggerEvent('sendMessage', {
          character: this.character,
          message: this.inputText.trim()
        })
      }
    }
  }
})
</script>

<style lang="stylus">
// å†…å®¹å¡ç‰‡
.content-card
  position relative
  z-index 3
  width 100%
  padding 0 32rpx
  margin-bottom 40rpx

  // ä»‹ç»éƒ¨åˆ†
  .intro-section
    background rgba(255, 255, 255, 0.12)
    backdrop-filter blur(20rpx)
    border-radius 20rpx
    padding 24rpx 28rpx
    margin-bottom 20rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .intro-label
      font-size 26rpx
      color rgba(255, 255, 255, 0.7)
      font-weight 500
      margin-right 8rpx

    .intro-text
      font-size 26rpx
      color rgba(255, 255, 255, 0.95)
      line-height 1.6

  // é—®å€™è¯­æ¶ˆæ¯
  .greeting-message
    width 80%
    color rgba(255, 255, 255, 0.95)
    background-color rgba(255, 255, 255, 0.6)
    backdrop-filter blur(20rpx)
    border-radius 20rpx
    padding 28rpx
    margin-bottom 60rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .message-text
      font-size 30rpx
      color #333
      line-height 1.6
      display block

  // ä¿¡æ¯å’Œå·¥å…·æ 
  .info-toolbar
    display flex
    justify-content space-between
    align-items center
    margin-bottom 20rpx
    padding 0 8rpx

    .character-meta
      display flex
      flex-direction column
      gap 8rpx

      .meta-name
        font-size 32rpx
        font-weight 700
        color #fff
        text-shadow 0 2px 8px rgba(0,0,0,0.3)

      .meta-author
        font-size 24rpx
        color rgba(255, 255, 255, 0.7)

    .action-tools
      display flex
      align-items center
      gap 24rpx

      .tool-item
        display flex
        flex-direction column
        align-items center
        gap 2rpx
        transition all 0.2s

        &:active
          transform scale(0.95)

        .tool-icon
          font-size 32rpx

        .tool-count
          font-size 20rpx
          color rgba(255, 255, 255, 0.8)

        &.favorite-tool.active
          background rgba(255, 100, 100, 0.25)
          border-color rgba(255, 100, 100, 0.4)

        &.pin-tool.active
          background rgba(255, 215, 0, 0.25)
          border-color rgba(255, 215, 0, 0.4)

  // è¾“å…¥æ¡†éƒ¨åˆ†
  .input-section
    display flex
    align-items center
    gap 16rpx
    background rgba(255, 255, 255, 0.12)
    backdrop-filter blur(20rpx)
    border-radius 16rpx
    padding 12rpx 16rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .chat-input
      flex 1
      height 64rpx
      background transparent
      border none
      font-size 28rpx
      color #fff
      padding 0 16rpx

      &::placeholder
        color rgba(255, 255, 255, 0.5)

    .send-btn
      height 64rpx
      padding 0 32rpx
      background rgba(255, 255, 255, 0.15)
      color rgba(255, 255, 255, 0.6)
      border-radius 32rpx
      font-size 28rpx
      border none
      transition all 0.2s

      &.active
        background linear-gradient(135deg, #667eea, #764ba2)
        color #fff

      &:active
        transform scale(0.98)

      &[disabled]
        opacity 0.5
</style>

<script type="application/json">
{
  "component": true
}
</script>
