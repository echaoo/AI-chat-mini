<template>
  <!-- å†…å®¹å¡ç‰‡ -->
  <view class="content-card">
    <!-- åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºè§’è‰²ä»‹ç»å’Œé—®å€™è¯­ -->
    <view wx:if="{{!hasStartedChat}}">
      <!-- è§’è‰²ä»‹ç»ï¼ˆä»…é¦–æ¬¡èŠå¤©æ˜¾ç¤ºï¼‰ -->
      <view class="intro-section" wx:if="{{!character.hasChatHistory && character.description}}">
        <text class="intro-label">ä»‹ç»ï¼š</text>
        <text class="intro-text">{{character.description}}</text>
      </view>

      <!-- é—®å€™è¯­æ¶ˆæ¯ -->
      <view class="greeting-message">
        <text class="message-text">{{character.greetingMessage || 'ä½ å¥½~'}}</text>
      </view>
    </view>

    <!-- èŠå¤©çŠ¶æ€ï¼šæ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view
      wx:else
      scroll-y
      class="message-list"
      scroll-into-view="{{scrollToView}}"
      scroll-with-animation
    >
      <view wx:if="{{loading}}" class="loading">
        <text>åŠ è½½ä¸­...</text>
      </view>

      <view wx:else>
        <message-bubble
          wx:for="{{messages}}"
          wx:key="id"
          id="msg-{{item.id}}"
          message="{{item}}"
        />
      </view>

      <!-- æ»šåŠ¨é”šç‚¹ -->
      <view id="scroll-bottom" class="scroll-anchor"></view>
    </scroll-view>

    <!-- è§’è‰²ä¿¡æ¯å’Œå·¥å…·æ  -->
    <view class="info-toolbar">
      <!-- å·¦ä¾§ï¼šè§’è‰²å’Œä½œè€…ä¿¡æ¯ -->
      <view class="character-meta">
        <text class="meta-name">{{character.name}}</text>
        <text class="meta-author">{{character.isOfficial ? 'å®˜æ–¹' : 'ç”¨æˆ·åˆ›å»º'}}</text>
      </view>

      <!-- å³ä¾§ï¼šå·¥å…·æŒ‰é’® -->
      <view class="action-tools">
        <!-- ç‚¹èµ -->
        <view class="tool-item" bindtap="handleLike">
          <text class="tool-icon">ğŸ‘</text>
          <text class="tool-count">{{character.likeCount || 0}}</text>
        </view>

        <!-- å†å²æ¶ˆæ¯ -->
        <view class="tool-item" bindtap="handleViewHistory">
          <text class="tool-icon">ğŸ’¬</text>
          <text class="tool-count">{{character.messageCount || 0}}</text>
        </view>

        <!-- æ”¶è— -->
        <view
          class="tool-item favorite-tool {{character.isFavorite ? 'active' : ''}}"
          bindtap="handleToggleFavorite"
        >
          <text class="tool-icon">{{character.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        </view>

        <!-- å›ºå®šåˆ°é¦–é¡µ -->
        <view
          class="tool-item pin-tool {{isPinned ? 'active' : ''}}"
          bindtap="handlePinToHome"
        >
          <text class="tool-icon">{{isPinned ? 'â˜…' : 'â˜†'}}</text>
        </view>
      </view>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-section">
      <input
        class="chat-input"
        type="text"
        placeholder="è¾“å…¥æ¶ˆæ¯å¼€å§‹èŠå¤©..."
        value="{{inputText}}"
        bindinput="handleInput"
        bindconfirm="handleSend"
        confirm-type="send"
        disabled="{{sending}}"
      />
      <button
        class="send-btn {{inputText ? 'active' : ''}}"
        bindtap="handleSend"
        disabled="{{sending || !inputText}}"
      >
        {{sending ? 'å‘é€ä¸­' : 'å‘é€'}}
      </button>
    </view>
  </view>
</template>

<script lang="ts">
import { createComponent } from '@mpxjs/core'
import { characterApi, conversationApi } from '../common/api'
import type { Character, Message, CreateConversationResponse, ConversationMessagesResponse, SendMessageResponse } from '../common/types'

const GREETING_CACHE_KEY = 'greeting_cache'
const CONVERSATION_CACHE_KEY = 'last_conversation_id'
const HOME_CHARACTER_CACHE_KEY = 'home_character'

// æ¯ N æ¡æ¶ˆæ¯è§¦å‘ä¸€æ¬¡æ‘˜è¦æ›´æ–°ï¼ˆ20æ¡ = 10è½®å¯¹è¯ï¼‰
const MEMORY_UPDATE_MESSAGE_INTERVAL = 20

createComponent({
  properties: {
    // è§’è‰²æ•°æ®
    character: {
      type: Object as () => Character,
      value: null
    } as any,
    // å¯¹è¯IDï¼ˆå¦‚æœæ˜¯ä»å†å²è¿›å…¥ï¼‰
    initialConversationId: {
      type: Number,
      value: 0
    },
    // åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦è‡ªåŠ¨å‘é€ï¼‰
    initialMessage: {
      type: String,
      value: ''
    }
  },

  data: {
    conversationId: 0,
    messages: [] as Message[],
    inputText: '',
    loading: false,
    sending: false,
    scrollToView: '',
    isPinned: false,
    hasStartedChat: false // æ˜¯å¦å·²å¼€å§‹èŠå¤©
  },

  lifetimes: {
    attached() {
      this.init()
    },

    detached() {
      // ç»„ä»¶å¸è½½æ—¶ï¼Œæ¸…é™¤é—®å€™è¯­ç¼“å­˜
      try {
        wx.removeStorageSync(GREETING_CACHE_KEY)
      } catch (e) {
        // å¿½ç•¥é”™è¯¯
      }

      // ç¼“å­˜å½“å‰ conversationId
      if (this.conversationId) {
        try {
          wx.setStorageSync(CONVERSATION_CACHE_KEY, this.conversationId)
        } catch (e) {
          // å¿½ç•¥é”™è¯¯
        }

        // è§¦å‘è®°å¿†æ‘˜è¦æ›´æ–°ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡é¡µé¢å¸è½½ï¼‰
        this.triggerMemoryUpdate()
      }
    }
  },

  methods: {
    // åˆå§‹åŒ–
    async init() {
      let conversationId = this.initialConversationId

      // å¦‚æœæ²¡æœ‰ä¼ å…¥ conversationIdï¼Œå°è¯•ä»ç¼“å­˜è·å–
      if (!conversationId && this.character?.id) {
        try {
          const cached = wx.getStorageSync(HOME_CHARACTER_CACHE_KEY)
          // å¦‚æœç¼“å­˜çš„è§’è‰²ä¸å½“å‰è§’è‰²åŒ¹é…ï¼Œä½¿ç”¨ç¼“å­˜çš„ conversationId
          if (cached && cached.characterId === this.character.id && cached.conversationId) {
            conversationId = cached.conversationId
          }
        } catch (e) {
          // å¿½ç•¥é”™è¯¯
        }
      }

      if (conversationId) {
        // å¦‚æœæœ‰ conversationIdï¼ŒåŠ è½½å·²æœ‰å¯¹è¯
        this.conversationId = conversationId
        await this.loadExistingConversation()

        // å¦‚æœæœ‰åˆå§‹æ¶ˆæ¯ï¼Œåœ¨åŠ è½½å®Œæˆåè‡ªåŠ¨å‘é€
        if (this.initialMessage) {
          setTimeout(() => {
            this.inputText = this.initialMessage
            this.handleSend()
          }, 500)
        }
      } else if (this.character?.id) {
        // å¦åˆ™åˆ›å»ºæ–°å¯¹è¯
        await this.createNewConversation()
      }

      this.checkIfPinned()
    },

    // åˆ›å»ºæ–°å¯¹è¯
    async createNewConversation() {
      try {
        this.loading = true

        // åˆ›å»ºå¯¹è¯ï¼ˆåç«¯ä¼šè¿”å›æ¶ˆæ¯åˆ—è¡¨ï¼‰
        const conversation: CreateConversationResponse = await conversationApi.createConversation(this.character.id)
        this.conversationId = conversation.id

        // ä½¿ç”¨åç«¯è¿”å›çš„æ¶ˆæ¯åˆ—è¡¨
        if (conversation.messages && conversation.messages.length > 0) {
          this.messages = conversation.messages.map((msg: any) => ({
            id: msg.id,
            conversationId: this.conversationId,
            role: msg.role,
            content: msg.content,
            tokens: null,
            createdAt: msg.createdAt
          }))
          this.hasStartedChat = true
        }

        this.loading = false
        this.scrollToBottom()
      } catch (err: any) {
        wx.showToast({ title: err.message || 'åˆå§‹åŒ–å¤±è´¥', icon: 'none' })
        this.loading = false
      }
    },

    // åŠ è½½å·²æœ‰å¯¹è¯
    async loadExistingConversation() {
      try {
        this.loading = true

        // åŠ è½½å¯¹è¯ä¿¡æ¯å’Œæ¶ˆæ¯å†å²
        const response: ConversationMessagesResponse = await conversationApi.getConversationMessages(this.conversationId)

        // ä¿å­˜æ¶ˆæ¯åˆ—è¡¨
        this.messages = response.messages || []
        this.hasStartedChat = this.messages.length > 0

        this.loading = false
        this.scrollToBottom()
      } catch (err: any) {
        wx.showToast({ title: err.message || 'åŠ è½½å¤±è´¥', icon: 'none' })
        this.loading = false
      }
    },

    // è¾“å…¥æ¡†å†…å®¹å˜åŒ–
    handleInput(e: any) {
      this.inputText = e.detail.value
    },

    // å‘é€æ¶ˆæ¯
    async handleSend() {
      const content = this.inputText.trim()
      if (!content || this.sending) return

      // å¦‚æœè¿˜æ²¡å¼€å§‹èŠå¤©ï¼Œå…ˆåˆ›å»ºå¯¹è¯
      if (!this.hasStartedChat) {
        await this.createNewConversation()
      }

      // 1. åˆ›å»ºå¹¶ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      const userMessage: Message = {
        id: Date.now(),
        conversationId: this.conversationId,
        role: 'user',
        content: content,
        tokens: null,
        createdAt: new Date().toISOString()
      }

      this.messages = [...this.messages, userMessage]
      this.inputText = ''
      this.sending = true
      this.hasStartedChat = true
      this.scrollToBottom()

      try {
        // 2. å‘é€æ¶ˆæ¯åˆ°åç«¯ï¼Œå¹¶æ¥æ”¶åŠ©æ‰‹æ¶ˆæ¯
        const response: SendMessageResponse = await conversationApi.sendMessage(this.conversationId, content)

        // 3. å°†åŠ©æ‰‹æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨
        this.messages = [...this.messages, response.assistantMessage]

        this.scrollToBottom()

        // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ‘˜è¦æ›´æ–°ï¼ˆæ¯ 20 æ¡æ¶ˆæ¯è§¦å‘ä¸€æ¬¡ï¼‰
        if (this.messages.length > 0 && this.messages.length % MEMORY_UPDATE_MESSAGE_INTERVAL === 0) {
          console.log(`[Memory] æ¶ˆæ¯æ•°è¾¾åˆ° ${this.messages.length}ï¼Œè§¦å‘æ‘˜è¦æ›´æ–°`)
          this.triggerMemoryUpdate()
        }
      } catch (err: any) {
        wx.showToast({ title: err.message || 'å‘é€å¤±è´¥', icon: 'none' })
      } finally {
        this.sending = false
      }
    },

    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
      this.$nextTick(() => {
        this.scrollToView = 'scroll-bottom'
      })
    },

    // æ£€æŸ¥æ˜¯å¦å·²å›ºå®šåˆ°é¦–é¡µï¼ˆä»æœ¬åœ°ç¼“å­˜åˆ¤æ–­ï¼Œç”¨äºå¿«é€Ÿæ˜¾ç¤ºï¼‰
    checkIfPinned() {
      try {
        const cached = wx.getStorageSync(HOME_CHARACTER_CACHE_KEY)
        this.isPinned = cached && cached.characterId === this.character?.id
      } catch (e) {
        this.isPinned = false
      }
    },

    // å›ºå®š/å–æ¶ˆå›ºå®šåˆ°é¦–é¡µ
    async handlePinToHome() {
      if (!this.character) {
        wx.showToast({ title: 'è§’è‰²ä¿¡æ¯åŠ è½½ä¸­...', icon: 'none' })
        return
      }

      try {
        // è°ƒç”¨åç«¯æ¥å£
        const result = await characterApi.togglePinToHome(this.character.id)
        this.isPinned = result.isPinnedToHome

        if (result.isPinnedToHome) {
          // å›ºå®šæˆåŠŸï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜
          const cacheData = {
            characterId: this.character.id,
            conversationId: this.conversationId || null,
            character: {
              id: this.character.id,
              name: this.character.name,
              avatarUrl: this.character.avatarUrl,
              description: this.character.description
            },
            timestamp: Date.now()
          }
          wx.setStorageSync(HOME_CHARACTER_CACHE_KEY, cacheData)
          wx.showToast({ title: 'å·²å›ºå®šåˆ°é¦–é¡µ', icon: 'success' })
        } else {
          // å–æ¶ˆå›ºå®šï¼Œæ¸…ç©ºæœ¬åœ°ç¼“å­˜
          wx.removeStorageSync(HOME_CHARACTER_CACHE_KEY)
          wx.showToast({ title: 'å·²å–æ¶ˆå›ºå®š', icon: 'success' })
        }

        // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°å…¶ä»–è§’è‰²å¡ç‰‡çš„å›ºå®šçŠ¶æ€
        this.triggerEvent('pinToHome', {
          character: this.character,
          isPinned: result.isPinnedToHome
        })
      } catch (e: any) {
        wx.showToast({ title: e.message || 'æ“ä½œå¤±è´¥', icon: 'none' })
      }
    },

    // ç‚¹èµ
    handleLike() {
      this.triggerEvent('like', { characterId: this.character.id })
    },

    // æŸ¥çœ‹å†å²æ¶ˆæ¯
    handleViewHistory() {
      this.triggerEvent('viewHistory', { characterId: this.character.id })
    },

    // åˆ‡æ¢æ”¶è—
    handleToggleFavorite() {
      this.triggerEvent('toggleFavorite', { characterId: this.character.id })
    },

    /**
     * è§¦å‘è®°å¿†æ‘˜è¦æ›´æ–°
     * å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡é¡µé¢æ“ä½œ
     */
    triggerMemoryUpdate() {
      if (!this.conversationId || !this.hasStartedChat) {
        return
      }

      // ä½¿ç”¨å¼‚æ­¥è°ƒç”¨ï¼Œä¸ç­‰å¾…ç»“æœ
      conversationApi.updateMemorySummary(this.conversationId)
        .then((result: { updated: boolean; message?: string; messagesProcessed?: number }) => {
          if (result.updated) {
            console.log(`[Memory] è®°å¿†æ‘˜è¦å·²æ›´æ–°ï¼Œå¤„ç†äº† ${result.messagesProcessed} æ¡æ¶ˆæ¯`)
          } else {
            console.log(`[Memory] ${result.message || 'æ— éœ€æ›´æ–°'}`)
          }
        })
        .catch((err: Error) => {
          // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
          console.warn('[Memory] æ‘˜è¦æ›´æ–°å¤±è´¥:', err.message)
        })
    }
  }
})
</script>

<style lang="stylus">
// å†…å®¹å¡ç‰‡
.content-card
  position relative
  z-index 3
  width 100%
  padding 0 32rpx
  margin-bottom 40rpx

  // ä»‹ç»éƒ¨åˆ†
  .intro-section
    background rgba(255, 255, 255, 0.12)
    backdrop-filter blur(20rpx)
    border-radius 20rpx
    padding 24rpx 28rpx
    margin-bottom 20rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .intro-label
      font-size 26rpx
      color rgba(255, 255, 255, 0.7)
      font-weight 500
      margin-right 8rpx

    .intro-text
      font-size 26rpx
      color rgba(255, 255, 255, 0.95)
      line-height 1.6

  // é—®å€™è¯­æ¶ˆæ¯
  .greeting-message
    width 80%
    color rgba(255, 255, 255, 0.95)
    background-color rgba(255, 255, 255, 0.6)
    backdrop-filter blur(20rpx)
    border-radius 20rpx
    padding 28rpx
    margin-bottom 60rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .message-text
      font-size 30rpx
      color #333
      line-height 1.6
      display block

  // æ¶ˆæ¯åˆ—è¡¨
  .message-list
    height 400rpx
    padding 32rpx 0
    margin-bottom 20rpx
    overflow-y auto

    .loading
      text-align center
      padding 100rpx 0
      color rgba(255, 255, 255, 0.7)
      font-size 28rpx

    .scroll-anchor
      height 1rpx

  // ä¿¡æ¯å’Œå·¥å…·æ 
  .info-toolbar
    display flex
    justify-content space-between
    align-items center
    margin-bottom 20rpx
    padding 0 8rpx

    .character-meta
      display flex
      flex-direction column
      gap 8rpx

      .meta-name
        font-size 32rpx
        font-weight 700
        color #fff
        text-shadow 0 2px 8px rgba(0,0,0,0.3)

      .meta-author
        font-size 24rpx
        color rgba(255, 255, 255, 0.7)

    .action-tools
      display flex
      align-items center
      gap 24rpx

      .tool-item
        display flex
        flex-direction column
        align-items center
        gap 2rpx
        transition all 0.2s

        &:active
          transform scale(0.95)

        .tool-icon
          font-size 32rpx

        .tool-count
          font-size 20rpx
          color rgba(255, 255, 255, 0.8)

        &.favorite-tool.active
          background rgba(255, 100, 100, 0.25)
          border-color rgba(255, 100, 100, 0.4)

        &.pin-tool.active
          background rgba(255, 215, 0, 0.25)
          border-color rgba(255, 215, 0, 0.4)

  // è¾“å…¥æ¡†éƒ¨åˆ†
  .input-section
    display flex
    align-items center
    gap 16rpx
    background rgba(255, 255, 255, 0.12)
    backdrop-filter blur(20rpx)
    border-radius 16rpx
    padding 12rpx 16rpx
    border 1rpx solid rgba(255, 255, 255, 0.15)

    .chat-input
      flex 1
      height 64rpx
      background transparent
      border none
      font-size 28rpx
      color #fff
      padding 0 16rpx

      &::placeholder
        color rgba(255, 255, 255, 0.5)

    .send-btn
      height 64rpx
      padding 0 32rpx
      background rgba(255, 255, 255, 0.15)
      color rgba(255, 255, 255, 0.6)
      border-radius 32rpx
      font-size 28rpx
      border none
      transition all 0.2s

      &.active
        background linear-gradient(135deg, #667eea, #764ba2)
        color #fff

      &:active
        transform scale(0.98)

      &[disabled]
        opacity 0.5
</style>

<script type="application/json">
{
  "component": true,
  "usingComponents": {
    "message-bubble": "./message-bubble"
  }
}
</script>
